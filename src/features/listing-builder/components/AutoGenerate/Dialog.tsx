import { useAtom } from 'jotai';
import { AnimatePresence } from 'motion/react';
import posthog from 'posthog-js';
import { useState } from 'react';

import { AnimateChangeInHeight } from '@/components/shared/AnimateChangeInHeight';
import { Dialog, DialogContent } from '@/components/ui/dialog';
import { type BountyType } from '@/generated/prisma/enums';
import { cn } from '@/utils/cn';

import { isAutoGenerateOpenAtom } from '../../atoms';
import { AutoGenerateForm } from './Form';
import { AutoGenerateType } from './Type';

export function AutoGenerateDialog() {
  const [stage, setStage] = useState<'type' | 'form' | 'loading' | 'result'>(
    'type',
  );
  const [type, setType] = useState<BountyType>('bounty');
  const [open, setOpen] = useAtom(isAutoGenerateOpenAtom);

  const handleTypeSelect = (type: BountyType) => {
    setType(type);
    setStage('form');
  };

  return (
    <Dialog
      open={open}
      onOpenChange={(open) => {
        if (!open) posthog.capture('close_auto-generate');
        setOpen(open);
      }}
    >
      <DialogContent
        className={cn('gap-0 border-0 p-4 focus-visible:ring-0 sm:max-w-160')}
        style={{
          borderImageWidth: '0px !important',
        }}
        onPointerDownOutside={(e) => e.preventDefault()}
        onInteractOutside={(e) => e.preventDefault()}
        aria-describedby="Auto Generate Listing"
        hideCloseIcon
        autoFocus={false}
      >
        <button className="sr-only" />
        <AnimateChangeInHeight>
          <AnimatePresence mode="popLayout">
            {stage === 'type' && (
              <AutoGenerateType onSelect={handleTypeSelect} />
            )}
            {stage === 'form' && (
              <AutoGenerateForm type={type} setType={setType} />
            )}
          </AnimatePresence>
        </AnimateChangeInHeight>
      </DialogContent>
    </Dialog>
  );
}
